<ng-container *ngIf="!showAnalyticsPanel">
  <div class="home-container">
    <div class="welcome-section">
      <h1>Welcome to the Student Management Dashboard</h1>
      <p>You have successfully logged in to the application.</p>
    </div>
    
    <div class="features-section">
      <div class="features-header">
<h2>Available Features</h2>
        <button
          *ngIf="isAdmin"
          type="button"
          class="bell-btn"
          (click)="toggleNotificationsPanel()"
        >
          <span class="bell-icon">üîî</span>
          <span class="badge" *ngIf="unreadNotificationsCount > 0">
            {{ unreadNotificationsCount }}
          </span>
        </button>
      </div>

      <div class="feature-cards">
        <div class="feature-card">
          <h3>Students Management</h3>
          <p>View and manage students in the student database.</p>
          <a routerLink="/student-list" class="feature-link">View Students List</a>
        </div>
        <div class="feature-card">
          <h3>Courses Management</h3>
          <p>View and manage courses with enrolled students.</p>
          <a routerLink="/course-list" class="feature-link">View Courses List</a>
        </div>
        <div class="feature-card" *ngIf="canViewAnalytics">
          <h3>Performance Insights</h3>
          <p>Analyse assessment trends across every student and branch.</p>
          <a routerLink="/student-performance" class="feature-link">Open Performance Dashboard</a>
        </div>
        <ng-container *ngIf="canManageStudents">
          <div class="feature-card">
            <h3>Add New Student</h3>
            <p>Add a new student to the database.</p>
            <a routerLink="/items" class="feature-link">Add Student</a>
          </div>
        </ng-container>

        <ng-container *ngIf="isAdmin">
          <div class="feature-card admin-card">
            <h3>Role Management</h3>
            <p>Promote users to admin and manage system roles.</p>
            <app-role-management></app-role-management>
          </div>
          <div class="feature-card">
            <h3>Add New Course</h3>
            <p>Add a new course to the database.</p>
            <a routerLink="/course-add" class="feature-link">Add Course</a>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- Admin Dashboard Sections  -->
    <ng-container *ngIf="isAdmin">
      <!-- Email Status Table in admin view -->
      <div class="admin-section">
        <div class="admin-section-header">
          <h2>Email Status</h2>
          <button
            class="clear-btn"
            (click)="onClearEmailStatus()"
            [disabled]="emailLoading || clearingEmails"
          >
            {{ clearingEmails ? 'Clearing‚Ä¶' : 'Clear All' }}
          </button>
        </div>
        <div *ngIf="emailLoading" class="loading-message">Loading email status...</div>
        <div *ngIf="emailError" class="error-message">{{ emailError }}</div>
        
        <!-- Email Status Alerts -->
        <div *ngIf="!emailLoading && !emailError && emailNotifications.length > 0" class="email-status-alerts">
          <div *ngIf="hasPendingEmails" class="email-alert email-alert-pending">
            <strong>‚ö†Ô∏è Email Pending:</strong> {{ pendingEmailCount }} email(s) are pending and will be sent by the scheduler.
          </div>
          <div *ngIf="hasFailedEmails" class="email-alert email-alert-failed">
            <strong>‚ùå Email Not Sent:</strong> {{ failedEmailCount }} email(s) failed to send. Check the table below for details.
          </div>
        </div>
        <div *ngIf="!emailLoading && !emailError" class="table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>To Email</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Sent Time</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let email of emailNotifications">
                <td>{{ email.id }}</td>
                <td>{{ email.toEmail }}</td>
                <td>{{ email.subject }}</td>
                <td>
                  <span [class]="'status-badge ' + getStatusClass(email.status)">
                    {{ email.status }}
                  </span>
                </td>
                <td>{{ formatDateTime(email.sentTime) }}</td>
              </tr>
              <tr *ngIf="emailNotifications.length === 0">
                <td colspan="5" class="no-data">No email records found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Combined Email Section -->
      <div class="admin-section">
        <div class="admin-section-header">
          <h2>Send Email</h2>
          <button
            *ngIf="emailType === 'individual'"
            class="clear-btn"
            type="button"
            (click)="loadStudentOptions(true)"
            [disabled]="studentOptionsLoading"
          >
            {{ studentOptionsLoading ? 'Loading‚Ä¶' : 'Reload students' }}
          </button>
        </div>
        <div class="email-form">
          <label class="form-label" for="email-type-select">Email Type</label>
          <select
            id="email-type-select"
            [(ngModel)]="emailType"
            name="emailType"
            class="email-type-select"
            (ngModelChange)="onEmailTypeChange()"
          >
            <option value="broadcast">Send Broadcast Email</option>
            <option value="individual">Send Individual Email</option>
          </select>

          <!-- Individual Email - Student Selection -->
          <div *ngIf="emailType === 'individual'">
            <div *ngIf="studentOptionsError" class="error-message">
              {{ studentOptionsError }}
            </div>
            <label class="form-label" for="student-select">Student</label>
            <select
              id="student-select"
              [(ngModel)]="selectedStudentId"
              name="selectedStudentId"
            >
              <option [ngValue]="null" disabled>Select a student</option>
              <option
                *ngFor="let student of studentOptions"
                [value]="student.id"
              >
                {{ student.name }} (ID: {{ student.id }})
              </option>
            </select>
          </div>

          <!-- Subject Field -->
          <label class="form-label" for="email-subject">Subject</label>
          <input
            *ngIf="emailType === 'broadcast'"
            id="email-subject"
            type="text"
            name="broadcastSubject"
            [(ngModel)]="broadcastSubject"
            placeholder="Exam timetable update"
          />
          <input
            *ngIf="emailType === 'individual'"
            id="email-subject"
            type="text"
            name="individualSubject"
            [(ngModel)]="individualSubject"
            placeholder="Hello from admin"
          />

          <!-- Message Field -->
          <label class="form-label" for="email-message">Message</label>
          <textarea
            *ngIf="emailType === 'broadcast'"
            id="email-message"
            name="broadcastMessage"
            rows="5"
            [(ngModel)]="broadcastMessage"
            placeholder="Dear students, ..."
          ></textarea>
          <textarea
            *ngIf="emailType === 'individual'"
            id="email-message"
            name="individualMessage"
            rows="5"
            [(ngModel)]="individualMessage"
            placeholder="Hi John, ..."
          ></textarea>

          <!-- Send Button -->
          <div class="form-actions">
            <button
              *ngIf="emailType === 'broadcast'"
              class="broadcast-btn"
              (click)="onSendBroadcastEmail()"
              [disabled]="!canSendBroadcast()"
            >
              {{ broadcastSending ? 'Sending‚Ä¶' : 'Send to all students' }}
            </button>
            <button
              *ngIf="emailType === 'individual'"
              class="broadcast-btn"
              type="button"
              (click)="onSendIndividualEmail()"
              [disabled]="!canSendIndividualEmail()"
            >
              {{ individualSending ? 'Sending‚Ä¶' : 'Send to student' }}
            </button>
          </div>

          <!-- Success/Error Messages -->
          <div *ngIf="emailType === 'broadcast'">
            <div *ngIf="broadcastSuccessMessage" class="success-message">
              {{ broadcastSuccessMessage }}
            </div>
            <div *ngIf="broadcastErrorMessage" class="error-message">
              {{ broadcastErrorMessage }}
            </div>
          </div>
          <div *ngIf="emailType === 'individual'">
            <div *ngIf="individualSuccessMessage" class="success-message">
              {{ individualSuccessMessage }}
            </div>
            <div *ngIf="individualErrorMessage" class="error-message">
              {{ individualErrorMessage }}
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</ng-container>

<section
  class="analytics-section"
  *ngIf="canViewAnalytics && showAnalyticsPanel"
>
  <div class="analytics-header">
    <h3>Complete Analytics</h3>
    <p>Students with recorded assessments grouped by overall percentage.</p>
  </div>

  <div class="chart-container" *ngIf="analyticsLoading">
    <div class="chart-loading">Loading analytics‚Ä¶</div>
  </div>

  <div class="chart-container" *ngIf="!analyticsLoading && analyticsError">
    <div class="chart-error">{{ analyticsError }}</div>
  </div>

  <div class="chart-container" *ngIf="!analyticsLoading && !analyticsError">
    <ng-container *ngIf="hasAnalyticsData; else emptyAnalytics">
      <div class="bar-chart">
        <div class="y-axis">
          <div class="y-label">No. of Students</div>
          <div class="tick" *ngFor="let tick of yAxisTicks">{{ tick }}</div>
        </div>
        <div class="chart-body">
          <div class="bars">
            <div class="bar" *ngFor="let bucket of analyticsBuckets">
              <div
                class="bar-fill"
                [style.height.%]="getBarHeight(bucket.count)"
              >
                <span class="bar-count">{{ bucket.count }}</span>
              </div>
              <div class="bar-label">{{ bucket.label }}</div>
            </div>
          </div>
          <div class="x-axis">
            <div class="x-label">Percentage Range</div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <ng-template #emptyAnalytics>
    <div class="chart-empty">No assessments recorded yet.</div>
  </ng-template>
</section>